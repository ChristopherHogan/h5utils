CC = @CC@
CFLAGS = @CFLAGS@
CPPFLAGS = @CPPFLAGS@
DEFS = @DEFS@
LIBS = @LIBS@
LDFLAGS = @LDFLAGS@
INSTALL = @INSTALL@
prefix = @prefix@
# c.f. AC_ARG_PROGRAM autoconf docs:
transform=@program_transform_name@
@SET_MAKE@

VERSION = @VERSION@
package = h5utils
distdir = $(package)-$(VERSION)

###########################################################################

OBJ_h5topng = h5topng.o arrayh5.o writepng.o
SRC_h5read = h5read.cc arrayh5.o
OBJ_h5totxt = h5totxt.o arrayh5.o
OBJ_h5fromtxt = h5fromtxt.o arrayh5.o
OBJ_h5fromh4 = h5fromh4.o arrayh5.o arrayh4.o

OCT_INSTALL_DIR = @OCT_INSTALL_DIR@
H5READ_INSTALL_TARGET = @H5READ_INSTALL_TARGET@
H5READ_UNINSTALL_TARGET = @H5READ_UNINSTALL_TARGET@
PNG_LIBS = @PNG_LIBS@
V5D_FILES = @V5D_FILES@
V5D_INCLUDES = @V5D_INCLUDES@

###########################################################################

TARGETS = h5fromtxt h5totxt @H5TOPNG_TARGET@ @H5READ_TARGET@ \
          @H5TOV5D_TARGET@ @H5FROMH4_TARGET@
INSTALL_TARGETS = $(TARGETS:%=%-install)
UNINSTALL_TARGETS = $(TARGETS:%=%-uninstall)

all: $(TARGETS)

###########################################################################

h5read.oct: $(SRC_h5read)
	mkoctfile $(SRC_h5read) $(LIBS)

h5topng: $(OBJ_h5topng)
	$(CC) $(CFLAGS) $(LDFLAGS) $(OBJ_h5topng) $(PNG_LIBS) $(LIBS) -o $@

h5totxt: $(OBJ_h5totxt)
	$(CC) $(CFLAGS) $(LDFLAGS) $(OBJ_h5totxt) $(LIBS) -o $@

h5fromtxt: $(OBJ_h5fromtxt)
	$(CC) $(CFLAGS) $(LDFLAGS) $(OBJ_h5fromtxt) $(LIBS) -o $@

h5fromh4: $(OBJ_h5fromh4)
	$(CC) $(CFLAGS) $(LDFLAGS) $(OBJ_h5fromh4) @H4_LIBS@ $(LIBS) -o $@

h5tov5d: h5tov5d.o
	$(CC) $(CFLAGS) $(LDFLAGS) h5tov5d.o $(V5D_FILES) \
              arrayh5.o $(LIBS) -o $@

h5tov5d.o: h5tov5d.c
	$(CC) -c $(DEFS) $(V5D_INCLUDES) $(CFLAGS) $< -o $@

.c.o:
	$(CC) -c $(DEFS) $(CPPFLAGS) $(CFLAGS) $< -o $@

###########################################################################

h5topng-install:
	$(INSTALL) -d $(prefix)/bin
	$(INSTALL) -d $(prefix)/man/man1
	$(INSTALL) -m 0755 -s h5topng $(prefix)/bin/`echo h5topng|sed '$(transform)'`
	$(INSTALL) -m 0644 h5topng.1 $(prefix)/man/man1

h5topng-uninstall:
	rm -f $(prefix)/bin/h5topng
	rm -f $(prefix)/man/man1/h5topng.1

h5totxt-install:
	$(INSTALL) -d $(prefix)/bin
	$(INSTALL) -d $(prefix)/man/man1
	$(INSTALL) -m 0755 -s h5totxt $(prefix)/bin/`echo h5totxt|sed '$(transform)'`
	$(INSTALL) -m 0644 h5totxt.1 $(prefix)/man/man1

h5totxt-uninstall:
	rm -f $(prefix)/bin/h5totxt
	rm -f $(prefix)/man/man1/h5totxt.1

h5fromtxt-install:
	$(INSTALL) -d $(prefix)/bin
	$(INSTALL) -d $(prefix)/man/man1
	$(INSTALL) -m 0755 -s h5fromtxt $(prefix)/bin/`echo h5fromtxt|sed '$(transform)'`
	$(INSTALL) -m 0644 h5fromtxt.1 $(prefix)/man/man1

h5fromtxt-uninstall:
	rm -f $(prefix)/bin/h5fromtxt
	rm -f $(prefix)/man/man1/h5fromtxt.1

h5fromh4-install:
	$(INSTALL) -d $(prefix)/bin
	$(INSTALL) -d $(prefix)/man/man1
	$(INSTALL) -m 0755 -s h5fromh4 $(prefix)/bin/`echo h5fromh4|sed '$(transform)'`
	$(INSTALL) -m 0644 h5fromh4.1 $(prefix)/man/man1

h5fromh4-uninstall:
	rm -f $(prefix)/bin/h5fromh4
	rm -f $(prefix)/man/man1/h5fromh4.1

h5tov5d-install:
	$(INSTALL) -d $(prefix)/bin
	$(INSTALL) -d $(prefix)/man/man1
	$(INSTALL) -m 0755 -s h5tov5d $(prefix)/bin/`echo h5tov5d|sed '$(transform)'`
	$(INSTALL) -m 0644 h5tov5d.1 $(prefix)/man/man1

h5tov5d-uninstall:
	rm -f $(prefix)/bin/h5tov5d
	rm -f $(prefix)/man/man1/h5tov5d.1

h5read-install:
	$(INSTALL) -d $(OCT_INSTALL_DIR)
	$(INSTALL) -m 0755 h5read.oct $(OCT_INSTALL_DIR)

h5read.oct-install: $(H5READ_INSTALL_TARGET)

h5read-uninstall:
	rm -f $(OCT_INSTALL_DIR)/h5read.oct

h5read.oct-uninstall: $(H5READ_UNINSTALL_TARGET)

###########################################################################

install: $(INSTALL_TARGETS)

uninstall: $(UNINSTALL_TARGETS)

dist:
	cvs export -D now -d $(distdir) $(package)
	pushd $(distdir) && autoconf && popd
	rm -f $(distdir).tar.gz
	GZIP="--best" tar chozf $(distdir).tar.gz $(distdir)
	rm -rf $(distdir)

clean:
	rm -f h5topng.o h5tov5d.o h5totxt.o h5fromtxt.o h5fromh4.o h5read.o arrayh5.o arrayh4.o writepng.o $(TARGETS) core a.out octave-core

distclean: clean
	rm -f config.cache Makefile config.log config.status config.h $(TARGETS)

maintainer-clean: distclean
	rm -f configure config.h.in
