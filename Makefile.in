CC = @CC@
CFLAGS = @CFLAGS@
CPPFLAGS = @CPPFLAGS@
DEFS = @DEFS@
LIBS = @LIBS@
LDFLAGS = @LDFLAGS@
INSTALL = @INSTALL@
prefix = @prefix@
datadir = @datadir@
mandir = @mandir@
# c.f. AC_ARG_PROGRAM autoconf docs:
transform=@program_transform_name@
@SET_MAKE@

VERSION = @VERSION@
package = h5utils
distdir = $(package)-$(VERSION)

###########################################################################

OBJ_h5topng = h5topng.o arrayh5.o h5utils.o writepng.o
SRC_h5read = h5read.cc arrayh5.o h5utils.o
OBJ_h5totxt = h5totxt.o arrayh5.o h5utils.o
OBJ_h5tovtk = h5tovtk.o arrayh5.o h5utils.o
OBJ_h5fromtxt = h5fromtxt.o arrayh5.o h5utils.o
OBJ_h5fromh4 = h5fromh4.o arrayh5.o h5utils.o arrayh4.o

OCT_INSTALL_DIR = @OCT_INSTALL_DIR@
H5READ_INSTALL_TARGET = @H5READ_INSTALL_TARGET@
H5READ_UNINSTALL_TARGET = @H5READ_UNINSTALL_TARGET@
PNG_LIBS = @PNG_LIBS@
V5D_FILES = @V5D_FILES@
V5D_INCLUDES = @V5D_INCLUDES@

###########################################################################

TARGETS = h5fromtxt h5totxt h5tovtk @H5TOPNG_TARGET@ @H5READ_TARGET@ @H5TOV5D_TARGET@ @H5FROMH4_TARGET@
INSTALL_TARGETS = $(TARGETS:%=%-install)
UNINSTALL_TARGETS = $(TARGETS:%=%-uninstall)

all: $(TARGETS)

###########################################################################

h5read.oct: $(SRC_h5read)
	mkoctfile $(DEFS) $(CPPFLAGS) $(SRC_h5read) $(LDFLAGS) $(LIBS)

h5topng: $(OBJ_h5topng)
	$(CC) $(CFLAGS) $(LDFLAGS) $(OBJ_h5topng) $(PNG_LIBS) $(LIBS) -o $@

h5totxt: $(OBJ_h5totxt)
	$(CC) $(CFLAGS) $(LDFLAGS) $(OBJ_h5totxt) $(LIBS) -o $@

h5tovtk: $(OBJ_h5tovtk)
	$(CC) $(CFLAGS) $(LDFLAGS) $(OBJ_h5tovtk) $(LIBS) -o $@

h5fromtxt: $(OBJ_h5fromtxt)
	$(CC) $(CFLAGS) $(LDFLAGS) $(OBJ_h5fromtxt) $(LIBS) -o $@

h5fromh4: $(OBJ_h5fromh4)
	$(CC) $(CFLAGS) $(LDFLAGS) $(OBJ_h5fromh4) @H4_LIBS@ $(LIBS) -o $@

h5tov5d: h5tov5d.o arrayh5.o h5utils.o
	$(CC) $(CFLAGS) $(LDFLAGS) h5tov5d.o $(V5D_FILES) \
              arrayh5.o h5utils.o $(LIBS) -o $@

h5tov5d.o: h5tov5d.c
	$(CC) -c $(DEFS) $(CPPFLAGS) $(V5D_INCLUDES) $(CFLAGS) $< -o $@

.c.o:
	$(CC) -c $(DEFS) $(CPPFLAGS) $(CFLAGS) $< -o $@

###########################################################################

COLORMAPS = autumn bluered bone colorcube cool copper flag gray hot	\
hsv jet lines pink prism spring summer vga winter

colormaps-install:
	$(INSTALL) -d $(datadir)/h5utils/colormaps
	for cmap in $(COLORMAPS); do $(INSTALL) -m 0644 colormaps/$$cmap $(datadir)/h5utils/colormaps || fail=yes; done && test -z "$$fail"

datadir-uninstall:
	rm -rf $(datadir)/h5utils

h5topng-install: colormaps-install
	$(INSTALL) -d $(prefix)/bin
	$(INSTALL) -d $(mandir)/man1
	$(INSTALL) -m 0755 -s h5topng $(prefix)/bin/`echo h5topng|sed '$(transform)'`
	$(INSTALL) -m 0644 h5topng.1 $(mandir)/man1

h5topng-uninstall: datadir-uninstall
	rm -f $(prefix)/bin/h5topng
	rm -f $(mandir)/man1/h5topng.1

h5totxt-install:
	$(INSTALL) -d $(prefix)/bin
	$(INSTALL) -d $(mandir)/man1
	$(INSTALL) -m 0755 -s h5totxt $(prefix)/bin/`echo h5totxt|sed '$(transform)'`
	$(INSTALL) -m 0644 h5totxt.1 $(mandir)/man1

h5totxt-uninstall:
	rm -f $(prefix)/bin/h5totxt
	rm -f $(mandir)/man1/h5totxt.1

h5tovtk-install:
	$(INSTALL) -d $(prefix)/bin
	$(INSTALL) -d $(mandir)/man1
	$(INSTALL) -m 0755 -s h5tovtk $(prefix)/bin/`echo h5tovtk|sed '$(transform)'`
	$(INSTALL) -m 0644 h5tovtk.1 $(mandir)/man1

h5tovtk-uninstall:
	rm -f $(prefix)/bin/h5tovtk
	rm -f $(mandir)/man1/h5tovtk.1

h5fromtxt-install:
	$(INSTALL) -d $(prefix)/bin
	$(INSTALL) -d $(mandir)/man1
	$(INSTALL) -m 0755 -s h5fromtxt $(prefix)/bin/`echo h5fromtxt|sed '$(transform)'`
	$(INSTALL) -m 0644 h5fromtxt.1 $(mandir)/man1

h5fromtxt-uninstall:
	rm -f $(prefix)/bin/h5fromtxt
	rm -f $(mandir)/man1/h5fromtxt.1

h5fromh4-install:
	$(INSTALL) -d $(prefix)/bin
	$(INSTALL) -d $(mandir)/man1
	$(INSTALL) -m 0755 -s h5fromh4 $(prefix)/bin/`echo h5fromh4|sed '$(transform)'`
	$(INSTALL) -m 0644 h5fromh4.1 $(mandir)/man1

h5fromh4-uninstall:
	rm -f $(prefix)/bin/h5fromh4
	rm -f $(mandir)/man1/h5fromh4.1

h5tov5d-install:
	$(INSTALL) -d $(prefix)/bin
	$(INSTALL) -d $(mandir)/man1
	$(INSTALL) -m 0755 -s h5tov5d $(prefix)/bin/`echo h5tov5d|sed '$(transform)'`
	$(INSTALL) -m 0644 h5tov5d.1 $(mandir)/man1

h5tov5d-uninstall:
	rm -f $(prefix)/bin/h5tov5d
	rm -f $(mandir)/man1/h5tov5d.1

h5read-install:
	$(INSTALL) -d $(OCT_INSTALL_DIR)
	$(INSTALL) -m 0755 h5read.oct $(OCT_INSTALL_DIR)

h5read.oct-install: $(H5READ_INSTALL_TARGET)

h5read-uninstall:
	rm -f $(OCT_INSTALL_DIR)/h5read.oct

h5read.oct-uninstall: $(H5READ_UNINSTALL_TARGET)

###########################################################################

install: $(INSTALL_TARGETS)

uninstall: $(UNINSTALL_TARGETS)

dist:
	cvs export -D now -d $(distdir) $(package)
	pushd $(distdir) && autoheader && autoconf && popd
	rm -f $(distdir).tar.gz
	GZIP="--best" tar chozf $(distdir).tar.gz $(distdir)
	rm -rf $(distdir)

clean:
	rm -f h5topng.o h5tov5d.o h5totxt.o h5tovtk.o h5fromtxt.o h5fromh4.o h5read.o arrayh5.o h5utils.o arrayh4.o writepng.o $(TARGETS) core a.out octave-core

distclean: clean
	rm -f config.cache Makefile config.log config.status config.h $(TARGETS)

maintainer-clean: distclean
	rm -f configure config.h.in
